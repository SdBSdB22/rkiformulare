<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RKI Formulare</title>
    <meta name="description"
          content="RKI Formulare für die Covid19-Impfung mit dem Testprofil der Corona Warn App ausfüllen">
    <link rel="shortcut icon" href="./favicon.ico">
    <link rel="stylesheet" href="./rkiformulare.css">
    <link rel="stylesheet" href="./pico.min.css">
    <script src="./html5-qrcode.js" type="text/javascript"></script>
</head>

<body class="container">

<!-- Header -->
<header>
    <hgroup>
        <h1>RKI Formulare</h1>
        <h2>F&uuml;lle RKI-Anamnese-Bogen und RKI Einwilligungsbogen mit Hilfe des Corona-Warn-App Testprofils aus</h2>
    </hgroup>
</header><!-- ./ Header -->

<!-- Main -->
<main>
    <section id="introduction">
        <details>
            <summary>Was ist das Corona-Warn-App Testprofil?</summary>
            <p>Bei dem Testprofil handelt es sich nicht um ein Impfzertifikat. Es muss separat angelegt werden. <a
                    href="https://www.coronawarn.app/de/faq/#rat_profile">Mehr Infos zum Testprofil</a></p>
        </details>
        <details>
            <summary>Wie erstelle ich mein Corona-Warn-App-Testprofil?</summary>
            <p>Die Corona-Warn-App öffnen und dann:</p>
            <div id="spacer">
                <img id="screenshot" src="schritt1.png" width="296" height="640">
                <img id="screenshot" src="schritt2_profil_anlegen.png" width="296" height="640">
            </div>
        </details>
        <details>
            <summary>Wie zeige ich mein Corona-Warn-App-Testprofil?</summary>
            <p>Nachdem das Testprofile angelegt wurde, die Corona-Warn-App öffnen und dann:</p>
            <div id="spacer">
                <img id="screenshot" src="schritt1.png" width="296" height="640">
                <img id="screenshot" src="schritt2_profil_anzeigen.png" width="296" height="640">
            </div>

        </details>
    </section>
    <section id="buttons">
        <button id="button">Testprofil QR-Code scannen</button>
        <div>
            <label for="BrowseImage" id="button"><span id="label_link"
                                                       role="button">Testprofil QR-Code aus Foto lesen</span></label>
            <input hidden type="file" id="BrowseImage" accept="image/*" name="pictureToScan" id="QR-Code-fileInput">
        </div>
        <div id="link"></div>

        <div id="reader" width="600px"></div>
        <select id="cameraBox" hidden></select>
        <script type="module">
            import {parseVcard, fillSelectionBox} from './rkiformulare.js';
            let cameraId;
            let cameras;
            let cameralabels = [];
            let j = 0;
            const changeCameraLabel= "-----Kamera Wechseln-----";
            const html5QrCode = new Html5Qrcode("reader");
            function openCamera() {
                document.getElementById("reader").hidden = false;
                Html5Qrcode.getCameras().then(devices => {
                    /**
                     * devices would be an array of objects of type:
                     * { id: "id", label: "label" }
                     */
                    if (devices && devices.length) {
                        let l = 0;
                        cameraId = devices[j];
                        cameras = devices;
                        for(let i = 0; i < cameras.length; i++){
                            cameralabels[i] = cameras[i].label;
                            l++;
                        }
                        cameralabels[l] = changeCameraLabel;
                        console.log(cameraId);
                        console.log(cameras);
                        console.log(cameralabels);
                    }
                    document.getElementById("cameraBox").hidden = false;
                    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                        html5QrCode.stop();
                        document.getElementById("cameraBox").hidden = true;
                        let RKIlink = document.createElement("a");
                        let user = parseVcard(decodedText);
                        const d = new Date();
                        window.sessionStorage.setItem('firstName', user.firstName);
                        window.sessionStorage.setItem('secondName', user.secondName);
                        window.sessionStorage.setItem('birthdate', user.birthDay);
                        window.sessionStorage.setItem('address', user.street +", "+ user.city+", " +user.zipCode);
                        window.sessionStorage.setItem('date', d.getDate()+"."+(d.getMonth()+1)+"."+d.getFullYear())

                        RKIlink.href = './rkiformulare.html?openPrintDialog=true';
                        RKIlink.innerHTML = "Link zum RKI Formular";
                        RKIlink.role = "button"
                        RKIlink.style.fontSize= "3em";
                        document.getElementById("link").appendChild(RKIlink);
                    };
                    const config = { fps: 10, qrbox: { width: 350, height: 350 }, disableFlip: true};
                    document.getElementById("cameraBox").innerHTML = "";
                    fillSelectionBox("cameraBox", cameralabels ,changeCameraLabel);
                    html5QrCode.start({ deviceId: { exact: cameraId.id} }, config, qrCodeSuccessCallback);
                });
            }
            document.querySelector('button').addEventListener('click', openCamera);
            document.querySelector('select').addEventListener('change', function(){
                j = document.querySelector('select').selectedIndex
                html5QrCode.stop();
                openCamera();
            });
            document.querySelector('input').addEventListener('change', e => {
                if (e.target.files.length == 0) {
                    return;
                }

                const imageFile = e.target.files[0];
                // Scan QR Code
                html5QrCode.scanFile(imageFile, true
                ).then(decodedText => {
                    // success, use decodedText
                    console.log(decodedText);
                    document.getElementById("reader").hidden = true;
                    let RKIlink = document.createElement("a");
                    let user = parseVcard(decodedText);
                    const d = new Date();
                    window.sessionStorage.setItem('firstName', user.firstName);
                    window.sessionStorage.setItem('secondName', user.secondName);
                    window.sessionStorage.setItem('birthdate', user.birthDay);
                    window.sessionStorage.setItem('address', user.street +", "+user.zipCode+" "+ user.city );
                    window.sessionStorage.setItem('date', d.getDate()+"."+(d.getMonth()+1)+"."+d.getFullYear())
                    RKIlink.href = './rkiformulare.html?openPrintDialog=true';
                    RKIlink.innerHTML = "Link zum RKI Formular";
                    RKIlink.style.fontSize= "3em";
                    RKIlink.role = "button"
                    RKIlink.style.fontSize= "3em";
                    document.getElementById("link").appendChild(RKIlink);
                })
                    .catch(err => {
                        // failure, handle it.
                        console.log(`Error scanning file. Reason: ${err}`)
                    });
            });
        </script>
    </section>
</main><!-- ./ Main -->

<!-- Footer -->
<footer>
    <small>
        <p>Teile unsere Webseite&nbsp;
            <a title="Teile auf Twitter" href="https://twitter.com/intent/tweet?text=https://rkiformulare.online/%20keine%20Lust%20auf%20Handschrift?%20Fülle%20RKI-Formulare%20mit%20Hilfe%20des%20Corona-Warn-App%20Testprofils%20aus"> <img src="twitter-icon.png" alt="" width="20px"> </a>
            <a title="Teile auf Twitter" href='https://www.facebook.com/sharer/sharer.php?u=https://rkiformulare.online/%20keine%20Lust%20auf%20Handschrift?%20Fülle%20RKI-Formulare%20mit%20Hilfe%20des%20Corona-Warn-App%20Testprofils%20aus'> <img src="facebook-icon.png" alt="" width="20px"> </a>
            &nbsp;
            <a href="impressum.html" id="impressum-link">Impressum</a>
        </p>
    </small>
</footer><!-- ./ Footer -->
</body>

</html>
